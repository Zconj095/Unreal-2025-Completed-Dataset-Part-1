// Converted from Unity C# to Unreal C++
#include "SystemAdministrationCommandLine.h"

#include "Engine/World.h"
#include "TimerManager.h"

ASystemAdministrationCommandLine::ASystemAdministrationCommandLine()
{
    PrimaryActorTick.bCanEverTick = false;
}

void ASystemAdministrationCommandLine::BeginPlay()
{
    Super::BeginPlay();

    UE_LOG(LogTemp, Log, TEXT("System Administration Command Line Initialized."));

    if (UWorld* World = GetWorld())
    {
        FTimerManager& TM = World->GetTimerManager();

        // Add a command every 5 seconds, start after 2 seconds
        TM.SetTimer(
            TimerHandle_AutoAdd,
            this,
            &ASystemAdministrationCommandLine::AutoAddCommand,
            5.0f,
            true,
            2.0f);

        // Execute a command every 7 seconds, start after 3 seconds
        TM.SetTimer(
            TimerHandle_AutoExecute,
            this,
            &ASystemAdministrationCommandLine::AutoExecuteCommand,
            7.0f,
            true,
            3.0f);

        // Replenish energy every 10 seconds, start after 4 seconds
        TM.SetTimer(
            TimerHandle_AutoReplenish,
            this,
            &ASystemAdministrationCommandLine::AutoReplenishEnergy,
            10.0f,
            true,
            4.0f);

        // Display commands every 12 seconds, start after 6 seconds
        TM.SetTimer(
            TimerHandle_Display,
            this,
            &ASystemAdministrationCommandLine::DisplayCommands,
            12.0f,
            true,
            6.0f);
    }
}

void ASystemAdministrationCommandLine::AddCommand(const FString& Content, const FString& Category)
{
    if (SharedEnergy < 10.f)
    {
        UE_LOG(LogTemp, Warning, TEXT("Not enough shared energy to create a new command."));
        return;
    }

    FCommandEntry Command(Content, Category);
    CommandDictionary.Add(Command);

    SharedEnergy -= 10.f;
    UE_LOG(LogTemp, Log, TEXT("New Command Added - ID: %s, Content: %s, Category: %s. Remaining Energy: %.2f"),
        *Command.CommandID, *Content, *Category, SharedEnergy);
}

void ASystemAdministrationCommandLine::DisplayCommands() const
{
    UE_LOG(LogTemp, Log, TEXT("Displaying all commands in the dictionary..."));
    for (const FCommandEntry& Command : CommandDictionary)
    {
        Command.Display();
    }
}

void ASystemAdministrationCommandLine::ReplenishEnergy(float Amount)
{
    SharedEnergy += Amount;
    UE_LOG(LogTemp, Log, TEXT("Shared Energy Replenished by %.2f units. Total Energy: %.2f"), Amount, SharedEnergy);
}

void ASystemAdministrationCommandLine::ExecuteCommand(const FString& CommandID)
{
    int32 Index = CommandDictionary.IndexOfByPredicate([&](const FCommandEntry& C){ return C.CommandID == CommandID; });
    if (Index != INDEX_NONE)
    {
        const FCommandEntry& Command = CommandDictionary[Index];
        UE_LOG(LogTemp, Log, TEXT("Executing Command - ID: %s, Content: %s"), *Command.CommandID, *Command.Content);
        SharedEnergy -= 5.f;
    }
    else
    {
        UE_LOG(LogTemp, Warning, TEXT("Command with ID '%s' not found."), *CommandID);
    }
}

void ASystemAdministrationCommandLine::ResetEnergy()
{
    SharedEnergy = 10000.f;
    UE_LOG(LogTemp, Log, TEXT("Shared Energy Reset to 10000 units."));
}

void ASystemAdministrationCommandLine::AutoAddCommand()
{
    static const TArray<FString> Categories = { TEXT("Simulation"), TEXT("Network"), TEXT("Energy"), TEXT("Debug") };
    const int32 CatIdx = FMath::RandRange(0, Categories.Num() - 1);
    const FString Category = Categories[CatIdx];
    const int32 Num = FMath::RandRange(1, 999);
    AddCommand(FString::Printf(TEXT("AutoGeneratedCommand-%d"), Num), Category);
}

void ASystemAdministrationCommandLine::AutoExecuteCommand()
{
    if (CommandDictionary.Num() > 0)
    {
        const FString CommandID = CommandDictionary[0].CommandID;
        ExecuteCommand(CommandID);
        CommandDictionary.RemoveAt(0);
    }
    else
    {
        UE_LOG(LogTemp, Warning, TEXT("No commands available to execute."));
    }
}

void ASystemAdministrationCommandLine::AutoReplenishEnergy()
{
    const float Amount = FMath::FRandRange(200.f, 500.f);
    ReplenishEnergy(Amount);
}

